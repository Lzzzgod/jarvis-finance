<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon.png') }}">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <title>Profile - Jarvis Advisor</title>
</head>
<body>
            {% extends 'layout.html' %}

            {% block title %}Relatórios {% endblock %}
            
            {% block content %}
            <div class="report-container">
                <div class="content">
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'financialReport')">Relatório Financeiro</button>
                    <button class="tab-button" onclick="openTab(event, 'iqReport')">IQ</button>
                </div>
            
                <div id="financialReport" class="tab-content active">
                    <h2>Relatório Financeiro</h2>
                    
                    <div class="period-selector">
                        <label for="period-selector">Selecione o período:</label>
                        <select id="period-selector">
                            <option value="month">Mês Atual</option>
                            <option value="year">Ano Atual</option>
                            <option value="all">Todo o Período</option>
                        </select>
                    </div>
                
                    <div class="chart-grid">
                        <div class="chart-item">
                            <canvas id="balanceChart"></canvas>
                        </div>
                        <div class="chart-item">
                            <canvas id="incomeVsExpensesChart"></canvas>
                        </div>
                        <div class="chart-item">
                            <canvas id="incomeCategoriesChart"></canvas>
                        </div>
                        <div class="chart-item">
                            <canvas id="expenseCategoriesChart"></canvas>
                        </div>
                    </div>
            
                </div>
            
                <div id="iqReport" class="tab-content">
                    <h2>Relatório IQ (Previsão)</h2>
                    <div class="chart-item">
                        <h3>Previsão de Receitas</h3>
                        <div id="forecastChart"></div>
                    </div>
                    <div class="metrics-container">
                        <h3>Métricas de Previsão</h3>
                        <p>Previsão para o Próximo Mês: R$ {{ previsao_proximo_mes | round(2) }}</p>
                        <p>Variação Percentual: {{ variacao_percentual | round(2) }}%</p>
                        <p>O intervalo sombreado no gráfico representa o intervalo de confiança da previsão.</p>
                    </div>
                    <div class="metrics-container">
                        <h3>Métricas Financeiras</h3>
                        <p>Total de Receitas: R$ {{ total_receitas | round(2) }}</p>
                        <p>Total de Despesas: R$ {{ total_despesas | round(2) }}</p>
                        <p>Saldo Atual: R$ {{ saldo | round(2) }}</p>
                    </div>
                </div>
            </div>
            
            
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            
            <script>

                var receitas_data = JSON.parse('{{ receitas_data | tojson | safe }}');
                var despesas_data = JSON.parse('{{ despesas_data | tojson | safe }}');
                var categorias_receitas_data = JSON.parse('{{ categorias_receitas_data | tojson | safe }}');
                var categorias_despesas_data = JSON.parse('{{ categorias_despesas_data | tojson | safe }}');
                var saldoAtual = JSON.parse('{{ saldo_atual | tojson | safe }}'); // Definindo saldoAtual aqui
                
                function createBalanceChart() {
                    var ctx = document.getElementById('balanceChart').getContext('2d');
                    var dates = Object.keys(receitas_data);
                    var balances = dates.map(function(date, index) {
                        var totalReceitas = Object.values(receitas_data).slice(0, index + 1).reduce((a, b) => a + b, 0);
                        var totalDespesas = Object.values(despesas_data).slice(0, index + 1).reduce((a, b) => a + b, 0);
                        return totalReceitas - totalDespesas;
                    });

                    // Adicionar o saldo atual como último ponto
                    dates.push('Atual');
                    balances.push(saldoAtual);  // Use a variável JavaScript aqui

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'Saldo',
                                data: balances,
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Saldo ao Longo do Tempo'
                                }
                            }
                        }
                    });
                }

                function createIncomeVsExpensesChart() {
    var ctx = document.getElementById('incomeVsExpensesChart').getContext('2d');
    var dates = Object.keys(receitas_data).sort();
    var accumulatedReceitas = [];
    var accumulatedDespesas = [];
    var totalReceitas = 0;
    var totalDespesas = 0;

    for (var i = 0; i < dates.length; i++) {
        var date = dates[i];
        totalReceitas += receitas_data[date] || 0;
        totalDespesas += despesas_data[date] || 0;
        accumulatedReceitas.push(totalReceitas);
        accumulatedDespesas.push(totalDespesas);
    }

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [
                {
                    label: 'Receitas Acumuladas',
                    data: accumulatedReceitas,
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true
                },
                {
                    label: 'Despesas Acumuladas',
                    data: accumulatedDespesas,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Receitas vs Despesas Acumuladas'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Data'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Valor Acumulado (R$)'
                    },
                    ticks: {
                        callback: function(value, index, values) {
                            return 'R$ ' + value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
}

                // Função para criar o gráfico de categorias de receitas
                function createIncomeCategoriesChart() {
                    var ctx = document.getElementById('incomeCategoriesChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(categorias_receitas_data),
                            datasets: [{
                                data: Object.values(categorias_receitas_data),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.6)',
                                    'rgba(54, 162, 235, 0.6)',
                                    'rgba(255, 206, 86, 0.6)',
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Categorias de Receitas'
                                }
                            }
                        }
                    });
                }

                // Função para criar o gráfico de categorias de despesas
                function createExpenseCategoriesChart() {
                    var ctx = document.getElementById('expenseCategoriesChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(categorias_despesas_data),
                            datasets: [{
                                data: Object.values(categorias_despesas_data),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.6)',
                                    'rgba(54, 162, 235, 0.6)',
                                    'rgba(255, 206, 86, 0.6)',
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Categorias de Despesas'
                                }
                            }
                        }
                    });
                }

                // Função para alternar entre as abas
                function openTab(evt, tabName) {
                    var i, tabContent, tabButtons;
                    
                    tabContent = document.getElementsByClassName("tab-content");
                    for (i = 0; i < tabContent.length; i++) {
                        tabContent[i].style.display = "none";
                    }
                    
                    tabButtons = document.getElementsByClassName("tab-button");
                    for (i = 0; i < tabButtons.length; i++) {
                        tabButtons[i].className = tabButtons[i].className.replace(" active", "");
                    }
                    
                    document.getElementById(tabName).style.display = "block";
                    evt.currentTarget.className += " active";
                }

                // Criar todos os gráficos quando a página carregar
                window.onload = function() {
                    createBalanceChart();
                    createIncomeVsExpensesChart();
                    createIncomeCategoriesChart();
                    createExpenseCategoriesChart();

                    // Carregar o gráfico de previsão
                    var plotData = JSON.parse('{{ plot_json | safe }}');
                    Plotly.newPlot('forecastChart', plotData.data, plotData.layout);
                };

                // Atualizar gráficos quando o período for alterado
                document.getElementById('period-selector').addEventListener('change', function() {
                    // Aqui você pode adicionar lógica para atualizar os dados com base no período selecionado
                    // Por enquanto, vamos apenas recriar os gráficos com os mesmos dados
                    createBalanceChart();
                    createIncomeVsExpensesChart();
                    createIncomeCategoriesChart();
                    createExpenseCategoriesChart();
                });

                function updateCharts(period) {
                    var filteredReceitas = {};
                    var filteredDespesas = {};
                    var currentDate = new Date();
                    var startDate;

                    if (period === 'month') {
                        startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                    } else if (period === 'year') {
                        startDate = new Date(currentDate.getFullYear(), 0, 1);
                    } else {
                        startDate = new Date(0); // Começo do tempo Unix para 'all'
                    }

                    for (var date in receitas_data) {
                        if (new Date(date) >= startDate) {
                            filteredReceitas[date] = receitas_data[date];
                        }
                    }

                    for (var date in despesas_data) {
                        if (new Date(date) >= startDate) {
                            filteredDespesas[date] = despesas_data[date];
                        }
                    }

                    // Atualize os gráficos com os dados filtrados
                    createBalanceChart(filteredReceitas, filteredDespesas);
                    createIncomeVsExpensesChart(filteredReceitas, filteredDespesas);
                    createIncomeCategoriesChart(filteredReceitas);
                    createExpenseCategoriesChart(filteredDespesas);
                }
                document.getElementById('period-selector').addEventListener('change', function() {
                updateCharts(this.value);
});
        </script>
        </div>
        {% endblock %}
        </div>
</body>
</html>
